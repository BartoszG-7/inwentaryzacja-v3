<div class="container right-project-container">
  @if (loading) {
  <div class="loading-overlay" role="status" aria-live="polite" aria-busy="true">
    <div class="spinner"></div>
    <div class="loading-text">Ładowanie…</div>
  </div>
  }
  <div class="header-row">
    <div class="header-left">
      <button
        type="button"
        class="back-arrow-btn"
        (click)="goToInwentaryzacja()"
        aria-label="Powrót do inwentaryzacji"
      >
        <i class="bi bi-arrow-90deg-left"></i>
      </button>
      <span class="header-title">{{ (project ?? { name: "" }).name }}</span>
    </div>
    <div class="header-actions">
      <app-search-bar
        [noPaddingBottom]="true"
        [showFilterModal]="true"
        (searchInput)="searchNoSort($event)"
      ></app-search-bar>
      <button class="header-btn">SKANUJ</button>
      <app-edit-projekt [data]="project"></app-edit-projekt>
      <!--edit-->
      <app-dodaj-modal-device
        [projectId]="selectedId"
        (refresh)="onRefresh($event)"
      ></app-dodaj-modal-device>
      <app-usun-modal-device
        (refresh)="onRefresh($event)"
        [projectId]="selectedId()"
        [markedDelete]="markedDelete"
      ></app-usun-modal-device>
    </div>
  </div>
  <div class="table-responsive right-table-responsive">
    <table
      class="table table-dark table-bordered table-hover align-middle mb-0 right-project-table stickyhead"
    >
      <colgroup>
        <col id="checkbox" />
        <col id="snWama" />
        <col id="snProd" />
        <col id="mac" />
        <col id="ip" />
        <col id="gateway" />
        <col id="mask" />
        <col id="anydesk" />
        <col id="dns1" />
        <col id="dns2" />
        <col id="server" />
        <col id="edit" />
      </colgroup>
      <thead>
        <tr>
          <th style="width: 32px"></th>
          <th
            style="width: 110px"
            (click)="toggleHeader('wamaNr')"
            [class.header-active]="isHeaderActive('wamaNr')"
          >
            SN WAMA
            @if (isHeaderActive('wamaNr') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('wamaNr') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th
            style="width: 110px"
            (click)="toggleHeader('serialNr')"
            [class.header-active]="isHeaderActive('serialNr')"
          >
            SN PROD
            @if (isHeaderActive('serialNr') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('serialNr') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th
            style="width: 90px"
            (click)="toggleHeader('macAddr')"
            [class.header-active]="isHeaderActive('macAddr')"
          >
            MAC
            @if (isHeaderActive('macAddr') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('macAddr') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th
            style="width: 90px"
            (click)="toggleHeader('ip')"
            [class.header-active]="isHeaderActive('ip')"
          >
            IP
            @if (isHeaderActive('ip') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('ip') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th
            style="width: 90px"
            (click)="toggleHeader('gateway')"
            [class.header-active]="isHeaderActive('gateway')"
          >
            BRAMA
            @if (isHeaderActive('gateway') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('gateway') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th
            style="width: 90px"
            (click)="toggleHeader('mask')"
            [class.header-active]="isHeaderActive('mask')"
          >
            MASKA
            @if (isHeaderActive('mask') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('mask') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th
            style="width: 90px"
            (click)="toggleHeader('remoteAccessId')"
            [class.header-active]="isHeaderActive('remoteAccessId')"
          >
            ANYDESK
            @if (isHeaderActive('remoteAccessId') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('remoteAccessId') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th
            style="width: 90px"
            (click)="toggleHeader('dns1')"
            [class.header-active]="isHeaderActive('dns1')"
          >
            DNS1
            @if (isHeaderActive('dns1') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('dns1') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th
            style="width: 90px"
            (click)="toggleHeader('dns2')"
            [class.header-active]="isHeaderActive('dns2')"
          >
            DNS2
            @if (isHeaderActive('dns2') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('dns2') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th
            style="width: 90px"
            (click)="toggleHeader('serverAddress')"
            [class.header-active]="isHeaderActive('serverAddress')"
          >
            SERWER
            @if (isHeaderActive('serverAddress') && activeSortDirection === 'desc') {
              <i class="bi bi-arrow-down"></i>
            }
            @if (isHeaderActive('serverAddress') && activeSortDirection === 'asc') {
              <i class="bi bi-arrow-up"></i>
            }
          </th>
          <th style="width: 90px"></th>
        </tr>
      </thead>
    </table>
    <table
      class="table table-dark table-bordered table-hover align-middle mb-0 right-project-table"
      [attr.aria-busy]="loading ? 'true' : 'false'"
    >
      <colgroup>
        <col id="checkbox" />
        <col id="snWama" />
        <col id="snProd" />
        <col id="mac" />
        <col id="ip" />
        <col id="gateway" />
        <col id="mask" />
        <col id="anydesk" />
        <col id="dns1" />
        <col id="dns2" />
        <col id="server" />
        <col id="edit" />
      </colgroup>
      <tbody>
        @if (isDevicesEmpty) {
          <tr class="empty-state-row">
            <td colspan="12">Brak urządzeń</td>
          </tr>
        } @else {
          <tr class="group-gap-row">
            <td colspan="12"></td>
          </tr>
          @for (group of groupedRows; track group; let i = $index) {
            <tr class="group-label-row">
              <td colspan="12" class="fw-bold text-uppercase text-center">
                <span class="group-header-center">
                  <span class="group-name">{{ group.name }}</span>
                  <span
                    class="group-badge"
                    [class.mismatch]="(group.needed ?? 0) > 0 && (group.assigned ?? 0) !== (group.needed ?? 0)"
                    [attr.title]="(group.assigned ?? 0) + '/' + (group.needed ?? 0)"
                  >
                    {{ group.assigned ?? 0 }}/{{ group.needed ?? 0 }}
                  </span>
                </span>
              </td>
            </tr>
            <tr class="group-gap-row group-gap-row-after-header">
              <td colspan="12"></td>
            </tr>
            @for (row of group.rows; track row) {
              <tr>
                <td>
                  <input
                    type="checkbox"
                    id="{{ row.id }}"
                    (change)="checkboxChanged($event)"
                  />
                </td>
                <td (dblclick)="copyCell(row.snWamasoft, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.snWamasoft" [attr.title]="row.snWamasoft">
                    {{ (row.snWamasoft?.length > 100) ? (row.snWamasoft | slice:0:100) + '...' : row.snWamasoft }}
                  </span>
                </td>
                <td (dblclick)="copyCell(row.snProducenta, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.snProducenta" [attr.title]="row.snProducenta">
                    {{ (row.snProducenta?.length > 100) ? (row.snProducenta | slice:0:100) + '...' : row.snProducenta }}
                  </span>
                </td>
                <td (dblclick)="copyCell(row.mac, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.mac" [attr.title]="row.mac">
                    {{ (row.mac?.length > 100) ? (row.mac | slice:0:100) + '...' : row.mac }}
                  </span>
                </td>
                <td (dblclick)="copyCell(row.ip, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.ip" [attr.title]="row.ip">
                    {{ (row.ip?.length > 100) ? (row.ip | slice:0:100) + '...' : row.ip }}
                  </span>
                </td>
                <td (dblclick)="copyCell(row.brama, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.brama" [attr.title]="row.brama">
                    {{ (row.brama?.length > 100) ? (row.brama | slice:0:100) + '...' : row.brama }}
                  </span>
                </td>
                <td (dblclick)="copyCell(row.maska, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.maska" [attr.title]="row.maska">
                    {{ (row.maska?.length > 100) ? (row.maska | slice:0:100) + '...' : row.maska }}
                  </span>
                </td>
                <td (dblclick)="copyCell(row.anydesk, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.anydesk" [attr.title]="row.anydesk">
                    {{ (row.anydesk?.length > 100) ? (row.anydesk | slice:0:100) + '...' : row.anydesk }}
                  </span>
                </td>
                <td (dblclick)="copyCell(row.dns1, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.dns1" [attr.title]="row.dns1">
                    {{ (row.dns1?.length > 100) ? (row.dns1 | slice:0:100) + '...' : row.dns1 }}
                  </span>
                </td>
                <td (dblclick)="copyCell(row.dns2, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.dns2" [attr.title]="row.dns2">
                    {{ (row.dns2?.length > 100) ? (row.dns2 | slice:0:100) + '...' : row.dns2 }}
                  </span>
                </td>
                <td (dblclick)="copyCell(row.serwer, $event)" (selectstart)="preventSelect($event)">
                  <span class="trunc" tabindex="0" [attr.data-title]="row.serwer" [attr.title]="row.serwer">
                    {{ (row.serwer?.length > 100) ? (row.serwer | slice:0:100) + '...' : row.serwer }}
                  </span>
                </td>
                <td class="text-end">
                  <app-edit-projekt-device [device]="row._raw" (saved)="onRefresh(true)"></app-edit-projekt-device>
                </td>
              </tr>
            }
            @if (i < groupedRows.length - 1) {
            <tr class="group-gap-row">
              <td colspan="12"></td>
            </tr>
            }
          }
        }
      </tbody>
    </table>
  </div>
</div>
